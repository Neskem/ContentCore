version: '3.5'
services:
    redis:
        container_name: redis
        image: redis:4.0
        ports:
            - "6379:6379"
        restart: always
    nginx:
        container_name: nginx
        image: nginx:1.12
        depends_on:
            - web
            - worker
        ports:
            - "80:80"
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf
            - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
        restart: always
    web:
        container_name: web
        build:
            context: ../
            dockerfile: Dockerfile
        image: breaktimeinc/breaktime.contentcore
        command: uwsgi --ini uwsgi.ini
        depends_on:
            - redis
        volumes:
           - ..:/usr/src/app
           - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=web
        expose:
            - "8700"
        ports:
            - "8100:8100"
            - "8700:8700"
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
    beat:
        container_name: beat
        image: breaktimeinc/breaktime.contentcore
        command: single-beat celery beat -A breakcontent.tasks -l info
        depends_on:
            - redis
        volumes:
            - ..:/usr/src/app
            - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=beat
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
    worker:
        container_name: worker
        image: breaktimeinc/breaktime.contentcore
        command: celery worker -A breakcontent.tasks --loglevel=DEBUG --autoscale=50,2 -n worker.%%h
        depends_on:
            - redis
        volumes:
           - ..:/usr/src/app
           - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=worker
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
    worker-upsert:
        container_name: worker-upsert
        image: breaktimeinc/breaktime.contentcore
        command: celery worker -A breakcontent.tasks -Q upsert_tm --loglevel=DEBUG --autoscale=50,2 -n worker.%%h
        volumes:
            - ..:/usr/src/app
            - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=worker-upsert
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
    worker-prep:
        container_name: worker-prep
        image: breaktimeinc/breaktime.contentcore
        command: celery worker -A breakcontent.tasks -Q prepare --loglevel=DEBUG --autoscale=50,1 -n worker-prep.%%h
        volumes:
            - ..:/usr/src/app
            - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=worker-prep
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
    worker-bypass:
        container_name: worker-bypass
        image: breaktimeinc/breaktime.contentcore
        command: celery worker -A breakcontent.tasks -Q bypass_crawler --loglevel=DEBUG --autoscale=50,2 -n worker-bypass.%%h
        volumes:
            - ..:/usr/src/app
            - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=worker-bypass
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
    worker-p1:
        container_name: worker-p1
        image: breaktimeinc/breaktime.contentcore
        command: celery worker -A breakcontent.tasks -Q priority_1 --loglevel=DEBUG --autoscale=20,2 -n worker-p1.%%h -E -P gevent --purge
        depends_on:
            - redis
        volumes:
            - ..:/usr/src/app
            - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=worker-p1
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
    worker-xpcrawler:
        container_name: worker-xpcrawler
        image: breaktimeinc/breaktime.contentcore
        command: celery worker -A breakcontent.tasks -Q xpcrawler --autoscale=100,4 -n worker-xpcrawler.%%h -E -P gevent
        depends_on:
            - redis
        volumes:
            - ..:/usr/src/app
            - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=worker-xpcrawler
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
    worker-xpmcrawler:
        container_name: worker-xpmcrawler
        image: breaktimeinc/breaktime.contentcore
        command: celery worker -A breakcontent.tasks -Q xpmcrawler --autoscale=100,4 -n worker-xpmcrawler.%%h -E -P gevent
        depends_on:
            - redis
        volumes:
            - ..:/usr/src/app
            - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=worker-xpmcrawler
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
    worker-aicrawler:
        container_name: worker-aicrawler
        image: breaktimeinc/breaktime.contentcore
        command: celery worker -A breakcontent.tasks -Q aicrawler --autoscale=20,2 -n worker-aicrawler.%%h -E -P gevent
        depends_on:
            - redis
        volumes:
            - ..:/usr/src/app
            - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=worker-aicrawler
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
