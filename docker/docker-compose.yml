version: '3.5'
services:
    redis:
        container_name: redis
        image: redis:4.0
        ports:
            - "6379:6379"
        restart: always
    nginx:
        container_name: nginx
        image: nginx:1.12
        depends_on:
            - content_core
        ports:
            - "80:80"
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf
            - ./nginx/default.conf:/etc/nginx/conf.d/default.conf
        restart: always
    psql:
        container_name: psql
        image: postgres
        volumes:
            - pgdata:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        restart: always
    content_core:
        container_name: content_core
        build:
            context: ../
            dockerfile: Dockerfile
        image: breaktimeinc/breaktime.contentcore
        command: supervisord -n
        # if need to build image in local environment
        # build:
        #    context: ../
        #    dockerfile: Dockerfile
        depends_on:
            - redis
        volumes:
           - /var/log/contentcore:/var/log/contentcore
        env_file: breakcontent.env
        environment:
            - CONTAINER_TAG=content_core
        expose:
            - "8700"
        ports:
            - "8100:8100"
            - "8700:8700"
        logging:
            driver: "json-file"
            options:
                max-size: "50m"
        restart: always
        healthcheck:
            test: ["CMD-SHELL", "curl -f http://localhost:8100/v1/create_tasks/1 && echo 'OK'"]
            interval: 30m30s
            timeout: 10s
            retries: 3
            start_period: 40s

    # hub:
    #     container_name: hub
    #     image: selenium/hub:3.13.0-argon
    #     environment:
    #         - GRID_MAX_SESSION=20
    #         - GRID_BROWSER_TIMEOUT=100000
    #         - GRID_TIMEOUT=90000
    #         - GRID_NEW_SESSION_WAIT_TIMEOUT=300000
    #     ports:
    #         - "4444:4444"
    # chrome:
    #     container_name: chrome
    #     image: selenium/node-chrome:3.13.0-argon
    #     volumes:
    #         - /dev/shm:/dev/shm
    #     depends_on:
    #         - hub
    #     environment:
    #         HUB_HOST: hub

    #         #volumes:
    #         #- /dev/shm:/dev/shm # Mitigates the Chromium issue described at https://code.google.com/p/chromium/issues/detail?id=519952

volumes:
    pgdata:
        external: true
